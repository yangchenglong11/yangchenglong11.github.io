<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>channel示例之GoTocket | yangcl&#39;s</title>
  <meta name="author" content="Yang Chenglong" />

  
  <meta name="description" content="Yangcl&#39;s Blog" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="channel示例之GoTocket" />
  <meta property="og:site_name" content="yangcl&#39;s" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="yangcl&#39;s" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">yangcl&#39;s</a></h1>
  <h2><a href="/">悟已往之不谏，知来者之可追。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
      <li><a href="https://github.com/yangchenglong11">github</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-05-26T03:54:34.000Z"><a href="/2017/05/26/channel示例之GoTocket/">2017-05-26</a></time>
      
      
  
    <h1 class="title">channel示例之GoTocket</h1>
  

    </header>
    <div class="entry">
      
        <p>该代码为批量处理人员信息，即将人员信息中的居住地进行统一处理。</p>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//定义员工数据结构</span></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name    <span class="keyword">string</span></div><div class="line">	Age     <span class="keyword">uint8</span></div><div class="line">	Address Addr</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义地址数据结构</span></div><div class="line"><span class="keyword">type</span> Addr <span class="keyword">struct</span> &#123;</div><div class="line">	city     <span class="keyword">string</span></div><div class="line">	district <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义处理接口，方法Batch被声明为实现批量处理人员信息功能的方法，</span></div><div class="line"><span class="comment">//其方法声明中的两个通道分别对该方法和该方法的调用方使用它的方式进行了约束</span></div><div class="line"><span class="keyword">type</span> PersonHandler <span class="keyword">interface</span> &#123;</div><div class="line">	Batch(origs &lt;-<span class="keyword">chan</span> Person) &lt;-<span class="keyword">chan</span> Person</div><div class="line">	Handle(orig *Person)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义空结构体，为其添加方法，实现PersonHandler接口</span></div><div class="line"><span class="keyword">type</span> PersonHandlerImpl <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler PersonHandlerImpl)</span> <span class="title">Batch</span><span class="params">(origs &lt;-<span class="keyword">chan</span> Person)</span> &lt;-<span class="title">chan</span> <span class="title">Person</span></span> &#123;</div><div class="line">	dests := <span class="built_in">make</span>(<span class="keyword">chan</span> Person, <span class="number">100</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> p := <span class="keyword">range</span> origs &#123;</div><div class="line">			handler.Handle(&amp;p)</div><div class="line">			dests &lt;- p</div><div class="line">		&#125;</div><div class="line">		fmt.Println(<span class="string">"All the information has been handled."</span>)</div><div class="line">		<span class="comment">//在发送方关闭通道</span></div><div class="line">		<span class="built_in">close</span>(dests)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> dests</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler PersonHandlerImpl)</span> <span class="title">Handle</span><span class="params">(orig *Person)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> orig.Address.district == <span class="string">"Haidian"</span> &#123;</div><div class="line">		orig.Address.district = <span class="string">"Shijingshan"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义要被处理的数据并初始化</span></div><div class="line"><span class="keyword">var</span> personTotal = <span class="number">200</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> persons []Person = <span class="built_in">make</span>([]Person, personTotal)</div><div class="line"></div><div class="line"><span class="keyword">var</span> personCount <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">200</span>; i++ &#123;</div><div class="line">		name := fmt.Sprintf(<span class="string">"%s%d"</span>, <span class="string">"P"</span>, i)</div><div class="line">		p := Person&#123;name, <span class="number">32</span>, Addr&#123;<span class="string">"Beijing"</span>, <span class="string">"Haidian"</span>&#125;&#125;</div><div class="line">		persons[i] = p</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//main函数中首先获取handler，初始化origs通道，将人员信息通过origs通道传入</span></div><div class="line"><span class="comment">//Batch中处理，处理后的信息放入dests通道中，并将dests通道返回。</span></div><div class="line"><span class="comment">//通道初始化完成后，fecthPerson获取人员信息放入到origs中，savePerson从dests中接收处理过的信息进行保存</span></div><div class="line"><span class="comment">//其中sign通道作用为在批处理完全执行结束之前阻塞主Goroutine</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	handler := getPersonHandler()</div><div class="line">	origs := <span class="built_in">make</span>(<span class="keyword">chan</span> Person, <span class="number">100</span>)</div><div class="line">	dests := handler.Batch(origs)</div><div class="line">	fecthPerson(origs)</div><div class="line">	sign := savePerson(dests)</div><div class="line">	&lt;-sign</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPersonHandler</span><span class="params">()</span> <span class="title">PersonHandler</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> PersonHandlerImpl&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">savePerson</span><span class="params">(dest &lt;-<span class="keyword">chan</span> Person)</span> &lt;-<span class="title">chan</span> <span class="title">byte</span></span> &#123;</div><div class="line">	sign := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		ok := <span class="literal">true</span></div><div class="line">		<span class="keyword">var</span> p Person</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="keyword">select</span> &#123;</div><div class="line">			<span class="keyword">case</span> p, ok = &lt;-dest:</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">if</span> !ok &#123;</div><div class="line">						fmt.Println(<span class="string">"All the information has been saved."</span>)</div><div class="line">						sign &lt;- <span class="number">0</span></div><div class="line">						<span class="keyword">break</span></div><div class="line">					&#125;</div><div class="line">					savePerson1(p)</div><div class="line">				&#125;</div><div class="line">			<span class="keyword">case</span> ok = &lt;-<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">chan</span> <span class="title">bool</span></span> &#123;</div><div class="line">				timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">					time.Sleep(time.Millisecond)</div><div class="line">					timeout &lt;- <span class="literal">false</span></div><div class="line">				&#125;()</div><div class="line">				<span class="keyword">return</span> timeout</div><div class="line">			&#125;() :</div><div class="line">				fmt.Println(<span class="string">"TimeOut!"</span>)</div><div class="line">				sign &lt;- <span class="number">0</span></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> sign</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fecthPerson</span><span class="params">(origs <span class="keyword">chan</span>&lt;- Person)</span></span> &#123;</div><div class="line">	<span class="comment">//调用cap函数确定origs是否为缓冲通道</span></div><div class="line">	origsCap := <span class="built_in">cap</span>(origs)</div><div class="line">	buffered := origsCap &gt; <span class="number">0</span></div><div class="line">	<span class="comment">//以origsCap的一半作为Goroutine票池的总数，创建票池</span></div><div class="line">	goTicketTotal := origsCap / <span class="number">2</span></div><div class="line">	goTicket := initGoTicket(goTicketTotal)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			p, ok := fecthPerson1()</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="keyword">for</span> &#123;</div><div class="line">					<span class="comment">//如果为非缓冲通道或者所有goroutine已完成工作，跳出循环</span></div><div class="line">					<span class="keyword">if</span> !buffered || <span class="built_in">len</span>(goTicket) == goTicketTotal &#123;</div><div class="line">						<span class="keyword">break</span></div><div class="line">					&#125;</div><div class="line">					time.Sleep(time.Nanosecond)</div><div class="line">				&#125;</div><div class="line">				fmt.Println(<span class="string">"All the information has been fetched."</span>)</div><div class="line">				<span class="comment">//在发送方关闭通道</span></div><div class="line">				<span class="built_in">close</span>(origs)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">//如果为缓冲通道，从goTicket接受一个值，表示有一个goroutine被占用</span></div><div class="line">			<span class="comment">//当操作完成后，向其中发送一个值，表示接解除占用</span></div><div class="line">			<span class="keyword">if</span> buffered &#123;</div><div class="line">				&lt;-goTicket</div><div class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">					origs &lt;- p</div><div class="line">					goTicket &lt;- <span class="number">1</span></div><div class="line">				&#125;()</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				origs &lt;- p</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//goTicket是为了限制该程序启用的goroutine的数量而声明的一个缓冲通道</span></div><div class="line"><span class="comment">//根据传进来的total初始化通道，total即表示可以启用goroutine数量</span></div><div class="line"><span class="comment">//每当启用一个goroutine时从该通道中接受一个值表示可用goroutine少了一个</span></div><div class="line"><span class="comment">//即每个goroutine要想启动必须要有ticket。上述是在origs为缓冲条件下，即整个过程为异步完成情况下</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initGoTicket</span><span class="params">(total <span class="keyword">int</span>)</span> <span class="title">chan</span> <span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> goTicket <span class="keyword">chan</span> <span class="keyword">byte</span></div><div class="line">	<span class="keyword">if</span> total == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> goTicket</div><div class="line">	&#125;</div><div class="line">	goTicket = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, total)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; total; i++ &#123;</div><div class="line">		goTicket &lt;- <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> goTicket</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fecthPerson1</span><span class="params">()</span> <span class="params">(Person, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> personCount &lt; personTotal &#123;</div><div class="line">		p := persons[personCount]</div><div class="line">		personCount++</div><div class="line">		<span class="keyword">return</span> p, <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> Person&#123;&#125;, <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">savePerson1</span><span class="params">(p Person)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">//定义员工数据结构</span></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name    <span class="keyword">string</span></div><div class="line">	Age     <span class="keyword">uint8</span></div><div class="line">	Address Addr</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义地址数据结构</span></div><div class="line"><span class="keyword">type</span> Addr <span class="keyword">struct</span> &#123;</div><div class="line">	city     <span class="keyword">string</span></div><div class="line">	district <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义处理接口，方法Batch被声明为实现批量处理人员信息功能的方法，</span></div><div class="line"><span class="comment">//其方法声明中的两个通道分别对该方法和该方法的调用方使用它的方式进行了约束</span></div><div class="line"><span class="keyword">type</span> PersonHandler <span class="keyword">interface</span> &#123;</div><div class="line">	Batch(origs &lt;-<span class="keyword">chan</span> Person) &lt;-<span class="keyword">chan</span> Person</div><div class="line">	Handle(orig *Person)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义空结构体，为其添加方法，实现PersonHandler接口</span></div><div class="line"><span class="keyword">type</span> PersonHandlerImpl <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler PersonHandlerImpl)</span> <span class="title">Batch</span><span class="params">(origs &lt;-<span class="keyword">chan</span> Person)</span> &lt;-<span class="title">chan</span> <span class="title">Person</span></span> &#123;</div><div class="line">	dests := <span class="built_in">make</span>(<span class="keyword">chan</span> Person, <span class="number">100</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> p := <span class="keyword">range</span> origs &#123;</div><div class="line">			handler.Handle(&amp;p)</div><div class="line">			dests &lt;- p</div><div class="line">		&#125;</div><div class="line">		fmt.Println(<span class="string">"All the information has been handled."</span>)</div><div class="line">		<span class="comment">//在发送方关闭通道</span></div><div class="line">		<span class="built_in">close</span>(dests)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> dests</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler PersonHandlerImpl)</span> <span class="title">Handle</span><span class="params">(orig *Person)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> orig.Address.district == <span class="string">"Haidian"</span> &#123;</div><div class="line">		orig.Address.district = <span class="string">"Shijingshan"</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//定义要被处理的数据并初始化</span></div><div class="line"><span class="keyword">var</span> personTotal = <span class="number">200</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> persons []Person = <span class="built_in">make</span>([]Person, personTotal)</div><div class="line"></div><div class="line"><span class="keyword">var</span> personCount <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">200</span>; i++ &#123;</div><div class="line">		name := fmt.Sprintf(<span class="string">"%s%d"</span>, <span class="string">"P"</span>, i)</div><div class="line">		p := Person&#123;name, <span class="number">32</span>, Addr&#123;<span class="string">"Beijing"</span>, <span class="string">"Haidian"</span>&#125;&#125;</div><div class="line">		persons[i] = p</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//main函数中首先获取handler，初始化origs通道，将人员信息通过origs通道传入</span></div><div class="line"><span class="comment">//Batch中处理，处理后的信息放入dests通道中，并将dests通道返回。</span></div><div class="line"><span class="comment">//通道初始化完成后，fecthPerson获取人员信息放入到origs中，savePerson从dests中接收处理过的信息进行保存</span></div><div class="line"><span class="comment">//其中sign通道作用为在批处理完全执行结束之前阻塞主Goroutine</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	handler := getPersonHandler()</div><div class="line">	origs := <span class="built_in">make</span>(<span class="keyword">chan</span> Person, <span class="number">100</span>)</div><div class="line">	dests := handler.Batch(origs)</div><div class="line">	fecthPerson(origs)</div><div class="line">	sign := savePerson(dests)</div><div class="line">	&lt;-sign</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPersonHandler</span><span class="params">()</span> <span class="title">PersonHandler</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> PersonHandlerImpl&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">savePerson</span><span class="params">(dest &lt;-<span class="keyword">chan</span> Person)</span> &lt;-<span class="title">chan</span> <span class="title">byte</span></span> &#123;</div><div class="line">	sign := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, <span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			p, ok := &lt;-dest</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				fmt.Println(<span class="string">"All the information has been saved."</span>)</div><div class="line">				sign &lt;- <span class="number">0</span></div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			savePerson1(p)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> sign</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fecthPerson</span><span class="params">(origs <span class="keyword">chan</span>&lt;- Person)</span></span> &#123;</div><div class="line">	<span class="comment">//调用cap函数确定origs是否为缓冲通道</span></div><div class="line">	origsCap := <span class="built_in">cap</span>(origs)</div><div class="line">	buffered := origsCap &gt; <span class="number">0</span></div><div class="line">	<span class="comment">//以origsCap的一半作为Goroutine票池的总数，创建票池</span></div><div class="line">	goTicketTotal := origsCap / <span class="number">2</span></div><div class="line">	goTicket := initGoTicket(goTicketTotal)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			p, ok := fecthPerson1()</div><div class="line">			<span class="keyword">if</span> !ok &#123;</div><div class="line">				<span class="keyword">for</span> &#123;</div><div class="line">					<span class="comment">//如果为非缓冲通道或者所有goroutine已完成工作，跳出循环</span></div><div class="line">					<span class="keyword">if</span> !buffered || <span class="built_in">len</span>(goTicket) == goTicketTotal &#123;</div><div class="line">						<span class="keyword">break</span></div><div class="line">					&#125;</div><div class="line">					time.Sleep(time.Nanosecond)</div><div class="line">				&#125;</div><div class="line">				fmt.Println(<span class="string">"All the information has been fetched."</span>)</div><div class="line">				<span class="comment">//在发送方关闭通道</span></div><div class="line">				<span class="built_in">close</span>(origs)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">//如果为缓冲通道，从goTicket接受一个值，表示有一个goroutine被占用</span></div><div class="line">			<span class="comment">//当操作完成后，向其中发送一个值，表示接解除占用</span></div><div class="line">			<span class="keyword">if</span> buffered &#123;</div><div class="line">				&lt;-goTicket</div><div class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">					origs &lt;- p</div><div class="line">					goTicket &lt;- <span class="number">1</span></div><div class="line">				&#125;()</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				origs &lt;- p</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//goTicket是为了限制该程序启用的goroutine的数量而声明的一个缓冲通道</span></div><div class="line"><span class="comment">//根据传进来的total初始化通道，total即表示可以启用goroutine数量</span></div><div class="line"><span class="comment">//每当启用一个goroutine时从该通道中接受一个值表示可用goroutine少了一个</span></div><div class="line"><span class="comment">//即每个goroutine要想启动必须要有ticket。上述是在origs为缓冲条件下，即整个过程为异步完成情况下</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initGoTicket</span><span class="params">(total <span class="keyword">int</span>)</span> <span class="title">chan</span> <span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> goTicket <span class="keyword">chan</span> <span class="keyword">byte</span></div><div class="line">	<span class="keyword">if</span> total == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> goTicket</div><div class="line">	&#125;</div><div class="line">	goTicket = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, total)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; total; i++ &#123;</div><div class="line">		goTicket &lt;- <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> goTicket</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fecthPerson1</span><span class="params">()</span> <span class="params">(Person, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> personCount &lt; personTotal &#123;</div><div class="line">		p := persons[personCount]</div><div class="line">		personCount++</div><div class="line">		<span class="keyword">return</span> p, <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> Person&#123;&#125;, <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">savePerson1</span><span class="params">(p Person)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
  
  <div class="categories">
    <a href="/categories/Golang/">Golang</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Golang/">Golang</a>
  </div>

        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yangchenglong11.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/BlockChain/">BlockChain</a><small>2</small></li>
  
    <li><a href="/categories/Docker/">Docker</a><small>1</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>15</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>5</small></li>
  
    <li><a href="/categories/MongoDB/">MongoDB</a><small>4</small></li>
  
    <li><a href="/categories/Network/">Network</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2018/03/16/the-store-of-block/">区块存储</a>
      </li>
    
      <li>
        <a href="/2018/03/14/merkle-patricia-tree/">Merkle Patricia Tree (梅克尔帕特里夏树) 详解</a>
      </li>
    
      <li>
        <a href="/2018/01/14/Network学习笔记/">Network学习笔记</a>
      </li>
    
      <li>
        <a href="/2017/07/15/iptables/">iptables</a>
      </li>
    
      <li>
        <a href="/2017/07/12/flag/">flag</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/BlockChain/">BlockChain</a><small>2</small></li>
  
    <li><a href="/tags/Docker/">Docker</a><small>1</small></li>
  
    <li><a href="/tags/Golang/">Golang</a><small>16</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>5</small></li>
  
    <li><a href="/tags/MongoDB/">MongoDB</a><small>4</small></li>
  
    <li><a href="/tags/Network/">Network</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/BlockChain/" style="font-size: 12.5px;">BlockChain</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Golang/" style="font-size: 20px;">Golang</a> <a href="/tags/Linux/" style="font-size: 17.5px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2018 Yang Chenglong
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
  
    <script type="text/javascript" src="/live2d/script.js"></script>
    <canvas id="live2dcanvas" width="300" height="400" class="live2d"></canvas>
    <style>
      #live2dcanvas {
        position: fixed;
        right: 0px;
        z-index: 999;
        pointer-events: none;
        bottom: -50px;
      }
    </style>
    <script>loadlive2d("live2dcanvas" ,"/live2d/assets/tororo/tororo.model.json",0.5)</script>
  
</body>
</html>