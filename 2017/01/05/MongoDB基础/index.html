<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  
  <title>MongoDB基础 | yangcl&#39;s</title>
  <meta name="author" content="Yang Chenglong" />

  
  <meta name="description" content="Yangcl&#39;s Blog" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <meta property="og:title" content="MongoDB基础" />
  <meta property="og:site_name" content="yangcl&#39;s" />

  
  

  
    <meta property="og:image" content="" />
  

  
  <link href="/css/images/favicon.ico" rel="icon" />
  

  <link rel="alternate" href="/atom.xml" title="yangcl&#39;s" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


  <!-- baidu webmaster push -->
  <script src='//push.zhanzhang.baidu.com/push.js'></script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">yangcl&#39;s</a></h1>
  <h2><a href="/">悟已往之不谏，知来者之可追。</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
      <li><a href="https://github.com/yangchenglong11">github</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-01-05T07:14:45.000Z"><a href="/2017/01/05/MongoDB基础/">2017-01-05</a></time>
      
      
  
    <h1 class="title">MongoDB基础</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>MongoDB 是一个基于分布式文件存储的数据库。由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。<br><a id="more"></a><br>它是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。</p>
<p>MongoDB非常强大，同时也非常容易上手。这里介绍一些MongoDB的基本概念。</p>
<ul>
<li>文档是MongoDB中的数据单元，非常类似于关系数据库管理系统中的行（但是比行要复杂得多）。</li>
<li>集合可以看作没有模式的表。</li>
<li>MongoDB的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限。</li>
<li>MongoDB自带简洁但功能强大的JavaScript shell，用来管理MongoDB实例和操作数据。</li>
<li>每一个文档都有一个特殊的键”_id”,它在文档所处的集合中是唯一的。</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>这里先介绍 mac 下如何安装，然后介绍使用 docker 进行安装。</p>
<h2 id="mac下安装"><a href="#mac下安装" class="headerlink" title="mac下安装"></a>mac下安装</h2><ul>
<li>首先，下载好Mongodb数据库，然后再打开下载好的文件；</li>
<li>在终端中，选择合适的位置，输入： sudo mkdir -p /data/db，创建数据库日志文件夹；</li>
<li>在终端输入：sudo chown -R  用户名 /data/db ，给予数据库日志文件夹操作权限；</li>
<li>进入 mongodb 的 “bin”目录，使用命令“ ./mongod ”启动mongoDB server，启动成功后最后一行应该是端口号，到这里Mongodb已经安装成了；</li>
<li>新建终端窗口，并输入 ./mongo ，登陆到数据库，接下来就可以进行操作了。</li>
</ul>
<h2 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h2><p>首先把 docker 镜像 pull 下来：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker pull mongo</div></pre></td></tr></table></figure>
<p>然后启动 mongo 镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --name mongo-name -v /home/docker/mongo_data:/data/db -d -p 27047:27017 mongo</div></pre></td></tr></table></figure>
<p>上面的命令中，我们创建一个mongo 容器，mongo-name 就是其名字， -v参数挂载本地目录 /home/docker/mongo_data 到容器的 /data/db 目录作为数据卷，-d参数使其在后台运行，-p 参数设置端口，使外界可以通过27047端口访问容器内27017端口，连接数据库。</p>
<p>mongo 镜像已经启动，我们可以使用下面的命令进入 mongo 进行操作 ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker exec -it mongo-name mongo</div></pre></td></tr></table></figure>
<p>接下来再介绍下mongo 的常用命令。</p>
<h2 id="简单命令"><a href="#简单命令" class="headerlink" title="简单命令"></a>简单命令</h2><p>首先是连接 mongo 服务，即启动客户端。如果要在27017端口连接本地的 mongo  服务，使用下面的命令即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mogno</div></pre></td></tr></table></figure>
<p>如果要连接远端的mongo 服务，则稍微麻烦点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongo xx.xx.xx.xx:port</div></pre></td></tr></table></figure>
<p>如果想退出mongo 客户端，输入 <code>exit</code>即可。</p>
<p>那如何关闭 mongo 服务呢？正常情况下我们可能会使用 <code>exit</code>或者<code>Ctrl+C</code>退出，但这样做是有隐患的，可能会导致数据丢失，或者无法再次启动mongo 服务，正确的做法是下面这样的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span><span class="bash"> use admin</span></div><div class="line"><span class="meta">&gt;</span><span class="bash"> db.shutdownServer()</span></div></pre></td></tr></table></figure>
<p>然后就是各种操作了～～～</p>
<h2 id="db"><a href="#db" class="headerlink" title="db"></a>db</h2><p>查看当前使用的数据库</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">yangs-Air</span><span class="params">(mongod-<span class="number">3.4</span>.<span class="number">0</span>)</span></span> &gt; db</div><div class="line">test</div></pre></td></tr></table></figure>
<p>切换数据库</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">yangs-Air</span><span class="params">(mongod-<span class="number">3.4</span>.<span class="number">0</span>)</span></span> &gt; use admin</div><div class="line">switched to db admin</div></pre></td></tr></table></figure>
<p>查看MongoDB实例拥有哪些数据库</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">yangs-Air</span>(<span class="selector-tag">mongod-3</span><span class="selector-class">.4</span><span class="selector-class">.0</span>) &gt; <span class="selector-tag">show</span> <span class="selector-tag">dbs</span>;</div><div class="line"><span class="selector-tag">admin</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">analy</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">github</span> → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">local</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">media</span>  → 0<span class="selector-class">.001GB</span></div><div class="line"><span class="selector-tag">test</span>   → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">test2</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">test3</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">test4</span>  → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">user</span>   → 0<span class="selector-class">.000GB</span></div><div class="line"><span class="selector-tag">work</span>   → 0<span class="selector-class">.000GB</span></div></pre></td></tr></table></figure>
<p>不需要显式创建数据库，当向数据库的某个collection插入文档时，数据库就被创建</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">yangs-Air(mongod-3.4.0) test&gt; show dbs</div><div class="line">admin  → 0.000GB</div><div class="line">analy  → 0.000GB</div><div class="line">test   → 0.000GB</div><div class="line">local  → 0.000GB</div><div class="line">yangs-Air(mongod-3.4.0) test&gt; use user</div><div class="line">switched <span class="keyword">to</span> db user</div><div class="line">yangs-Air(mongod-3.4.0) github&gt; show dbs</div><div class="line">admin → 0.000GB</div><div class="line">analy → 0.000GB</div><div class="line">local → 0.000GB</div><div class="line">test  → 0.000GB</div><div class="line">yangs-Air(mongod-3.4.0) user&gt; db.users.insert(&#123;<span class="string">"name"</span>:<span class="string">"yang"</span>&#125;)</div><div class="line">Inserted 1 record(s) <span class="keyword">in</span> 87ms</div><div class="line">WriteResult(&#123;</div><div class="line">  <span class="string">"nInserted"</span>: 1</div><div class="line">&#125;)</div><div class="line">yangs-Air(mongod-3.4.0) user&gt; show dbs</div><div class="line">admin  → 0.000GB</div><div class="line">analy  → 0.000GB</div><div class="line">local  → 0.000GB</div><div class="line">test   → 0.000GB</div><div class="line">user   → 0.000GB</div></pre></td></tr></table></figure>
<p>有一些数据库名是保留的，可以直接访问这些具有特殊语义的数据库，同时自己命名数据库时注意不要使用这些名字。</p>
<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><p>mongo是一个简化的javaScript shell，shell内置了帮助文档，使用help查看</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">yangs-Air(mongod-3.4.0) github&gt; <span class="keyword">help</span></div><div class="line">	<span class="keyword">db</span>.<span class="keyword">help</span>()                    <span class="keyword">help</span> <span class="keyword">on</span> <span class="keyword">db</span> methods</div><div class="line">	<span class="keyword">db</span>.mycoll.<span class="keyword">help</span>()             <span class="keyword">help</span> <span class="keyword">on</span> collection methods</div><div class="line">	<span class="keyword">sh</span>.<span class="keyword">help</span>()                    sharding helpers</div><div class="line">	rs.<span class="keyword">help</span>()                    replica <span class="keyword">set</span> helpers</div><div class="line">	<span class="keyword">help</span> admin                   administrative <span class="keyword">help</span></div><div class="line">	......</div><div class="line">	<span class="keyword">exit</span>                         quit the mongo <span class="keyword">shell</span></div></pre></td></tr></table></figure>
<p>通过db.help()查看数据库级别的帮助：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span><span class="bash"> db.help()</span></div><div class="line">DB methods:</div><div class="line">	db.auth(username, password)</div><div class="line">	db.createCollection(name, &#123; size : ..., capped : ..., max : ... &#125; )</div><div class="line">	db.createView(name, viewOn, [ &#123; $operator: &#123;...&#125;&#125;, ... ], &#123; viewOptions &#125; )</div><div class="line">	db.createUser(userDocument)</div><div class="line">	......</div><div class="line">	db.dropDatabase()</div><div class="line">	db.eval() - deprecated</div><div class="line">	db.getName()</div><div class="line">	db.getPrevError()</div><div class="line">	db.printSlaveReplicationInfo()</div><div class="line">	db.dropUser(username)</div><div class="line">	db.shutdownServer()</div><div class="line">	db.stats()</div><div class="line">	db.version() current version of the server</div></pre></td></tr></table></figure>
<p>使用db.foo.help()查看集合级别的帮助:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span><span class="bash"> db.foo.help()</span></div><div class="line">DBCollection help</div><div class="line">	db.foo.find().help() - show DBCursor help</div><div class="line">	db.foo.find(...).count()</div><div class="line">	db.foo.find(...).limit(n)</div><div class="line">	......</div><div class="line">	db.foo.findOne([query], [fields], [options], [readConcern])</div><div class="line">	db.foo.latencyStats() - display operation latency histograms for this collection</div></pre></td></tr></table></figure>
<p>在shell中输入函数名，不加小括号，就可以看到相应函数的JavaScript实现代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&gt; db.user.find</div><div class="line"><span class="function"><span class="keyword">function</span> (<span class="params">query, fields, limit, skip, batchSize, options</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> cursor = <span class="keyword">new</span> DBQuery(<span class="keyword">this</span>._mongo,</div><div class="line">                             <span class="keyword">this</span>._db,</div><div class="line">                             <span class="keyword">this</span>,</div><div class="line">                             <span class="keyword">this</span>._fullName,</div><div class="line">                             <span class="keyword">this</span>._massageObject(query),</div><div class="line">                             fields,</div><div class="line">                             limit,</div><div class="line">                             skip,</div><div class="line">                             batchSize,</div><div class="line">                             options || <span class="keyword">this</span>.getQueryOptions());</div><div class="line"></div><div class="line">    <span class="keyword">var</span> connObj = <span class="keyword">this</span>.getMongo();</div><div class="line">    <span class="keyword">var</span> readPrefMode = connObj.getReadPrefMode();</div><div class="line">    <span class="keyword">if</span> (readPrefMode != <span class="literal">null</span>) &#123;</div><div class="line">        cursor.readPref(readPrefMode, connObj.getReadPrefTagSet());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> rc = connObj.getReadConcern();</div><div class="line">    <span class="keyword">if</span> (rc) &#123;</div><div class="line">        cursor.readConcern(rc);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> cursor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="shell中的基本操作"><a href="#shell中的基本操作" class="headerlink" title="shell中的基本操作"></a>shell中的基本操作</h2><h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><p><strong>insert即向 collection添加新的 documents.如果插入时集合不存在,插入操作会创建该集合。</strong></p>
<p>MongoDB中提供了以下方法来插入文档到一个集合:</p>
<ul>
<li>db.collection.insert()</li>
<li>db.collection.insertOne()</li>
<li>db.collection.insertMany()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.COLLECTION_NAME.insert(document)</div></pre></td></tr></table></figure>
<p><strong>实例</strong></p>
<p><strong>db.collection.insert()向集合插入一个或多个文档.要想插入一个文档,传递一个文档给该方法;要想插入多个文档,传递文档数组给该方法.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;db.col.insert(&#123;&quot;name&quot;:&quot;test&quot;&#125;)</div></pre></td></tr></table></figure>
<p>该操作返回了含有操作状态的 WriteResult对象.插入文档成功返回如下WriteResult 对象:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">WriteResult</span><span class="params">(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span></span></div></pre></td></tr></table></figure>
<p>nInserted字段指明了插入文档的总数.如果该操作遇到了错误, WriteResult 对象将包含该错误信息.</p>
<p>下面我们看下插入多个文档时的情况：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; db.users.insert(</div><div class="line">...    [</div><div class="line">...      &#123; <span class="string">name:</span> <span class="string">"bob"</span>, <span class="string">age:</span> <span class="number">42</span>, <span class="string">status:</span> <span class="string">"A"</span>, &#125;,</div><div class="line">...      &#123; <span class="string">name:</span> <span class="string">"ahn"</span>, <span class="string">age:</span> <span class="number">22</span>, <span class="string">status:</span> <span class="string">"A"</span>, &#125;,</div><div class="line">...      &#123; <span class="string">name:</span> <span class="string">"xi"</span>, <span class="string">age:</span> <span class="number">34</span>, <span class="string">status:</span> <span class="string">"D"</span>, &#125;</div><div class="line">...    ]</div><div class="line">... )</div></pre></td></tr></table></figure>
<p>该方法返回了包含操作状态的 BulkWriteResult对象.成功插入文档返回如下 BulkWriteResult对象:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">BulkWriteResult(&#123;</div><div class="line">	<span class="string">"writeErrors"</span> : [ ],</div><div class="line">	<span class="string">"writeConcernErrors"</span> : [ ],</div><div class="line">	<span class="string">"nInserted"</span> : 3,</div><div class="line">	<span class="string">"nUpserted"</span> : 0,</div><div class="line">	<span class="string">"nMatched"</span> : 0,</div><div class="line">	<span class="string">"nModified"</span> : 0,</div><div class="line">	<span class="string">"nRemoved"</span> : 0,</div><div class="line">	<span class="string">"upserted"</span> : [ ]</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>现在我们可以调用find()查看一下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; db.col.find()</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5870c0b3d599544ddbd1d575&quot;), &quot;name&quot; : &quot;test&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5870cf70d599544ddbd1d579&quot;), &quot;name&quot; : &quot;bob&quot;, &quot;age&quot; : 42, &quot;status&quot; : &quot;A&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5870cf70d599544ddbd1d57a&quot;), &quot;name&quot; : &quot;ahn&quot;, &quot;age&quot; : 22, &quot;status&quot; : &quot;A&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5870cf70d599544ddbd1d57b&quot;), &quot;name&quot; : &quot;xi&quot;, &quot;age&quot; : 34, &quot;status&quot; : &quot;D&quot; &#125;</div></pre></td></tr></table></figure>
<p>可以看到已经插入成功，但每个文档都多了一个字段：”_id”,它是那里来的呢？</p>
<p><strong>MongoDB中储存的文档必须有一个”_id”键。这个键可以是任意类型的，默认为ObjectId对象。在一个集合中，每个文档都有唯一的”_id”值，来确保集合里面每个文档都能被唯一标识。如果插入文档的时候没有”_id”键,系统会自动帮你创建一个。这就是为什会多出来一个”_id”字段。</strong></p>
<p>接下来看下另外两个函数。</p>
<p><strong>db.collection.insertOne() 向集合插入单个document。</strong></p>
<p><strong>db.collection.insertMany()向集合插入多个 documents。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; db.users.insertMany(</div><div class="line">   [</div><div class="line">     &#123; name: &quot;bob&quot;, age: 42, status: &quot;A&quot;, &#125;,</div><div class="line">     &#123; name: &quot;ahn&quot;, age: 22, status: &quot;A&quot;, &#125;,</div><div class="line">     &#123; name: &quot;xi&quot;, age: 34, status: &quot;D&quot;, &#125;</div><div class="line">   ]</div><div class="line">)</div></pre></td></tr></table></figure>
<p>例子同前。</p>
<h3 id="query"><a href="#query" class="headerlink" title="query"></a>query</h3><p>MongoDB 查询数据的语法格式如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;db<span class="selector-class">.COLLECTION_NAME</span><span class="selector-class">.find</span>(&lt;query <span class="attribute">filter</span>&gt;, &lt;projection&gt;)</div></pre></td></tr></table></figure>
<p>第一个大括号为filter，第二个为投影，即你想显示的值。</p>
<p>find() 方法以非结构化的方式来显示所有文档。</p>
<p>如果你需要以易读的方式来读取数据，可以使用 pretty() 方法，语法格式如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;<span class="selector-tag">db</span><span class="selector-class">.COLLECTION_NAME</span><span class="selector-class">.find</span>()<span class="selector-class">.pretty</span>()</div></pre></td></tr></table></figure>
<p>除了 find() 方法之外，还有一个 findOne() 方法，它只返回一个文档。</p>
<h4 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;<span class="selector-tag">db</span><span class="selector-class">.users</span><span class="selector-class">.find</span>( &#123; <span class="attribute">status</span>: <span class="string">"A"</span> &#125; )</div><div class="line"></div><div class="line">&gt;<span class="selector-tag">db</span><span class="selector-class">.users</span><span class="selector-class">.find</span>( &#123; <span class="attribute">status</span>: <span class="string">"A"</span>, age: &#123; $lt: <span class="number">30</span> &#125; &#125; )</div></pre></td></tr></table></figure>
<p>上面四个例子中，第一个查询字段status的值为”A”的文档，第二个查询status的值为”A”,且age的值小于30的文档。</p>
<p>下表是一一些比较操作的示例：</p>
<table>
<thead>
<tr>
<th style="text-align:left">操作</th>
<th style="text-align:left">格式格式</th>
<th style="text-align:left">范例</th>
<th style="text-align:left">RDBMS类似语句</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">等于</td>
<td style="text-align:left">{<key>:<value>}</value></key></td>
<td style="text-align:left">db.col.find({“name”:”mon”})</td>
<td style="text-align:left">where name = “mon”</td>
</tr>
<tr>
<td style="text-align:left">小于</td>
<td style="text-align:left">{<key>:{$lt:<value>}}</value></key></td>
<td style="text-align:left">db.col.find({“count”:{$lt:50}})</td>
<td style="text-align:left">where count &lt; 50</td>
</tr>
<tr>
<td style="text-align:left">小于或等于</td>
<td style="text-align:left">{<key>:{$lte:<value>}}</value></key></td>
<td style="text-align:left">db.col.find({“count”:{$lte:50}})</td>
<td style="text-align:left">where count &lt;= 50</td>
</tr>
<tr>
<td style="text-align:left">大于</td>
<td style="text-align:left">{<key>:{$gt:<value>}}</value></key></td>
<td style="text-align:left">db.col.find({“count”:{$gt:50}})</td>
<td style="text-align:left">where count&gt; 50</td>
</tr>
<tr>
<td style="text-align:left">大于或等于</td>
<td style="text-align:left">{<key>:{$gte:<value>}}</value></key></td>
<td style="text-align:left">db.col.find({“count”:{$gte:50}})</td>
<td style="text-align:left">where count &gt;= 50</td>
</tr>
<tr>
<td style="text-align:left">不等于</td>
<td style="text-align:left">{<key>:{$ne:<value>}}</value></key></td>
<td style="text-align:left">db.col.find({“count”:{$ne:50}})</td>
<td style="text-align:left">where count != 50</td>
</tr>
</tbody>
</table>
<h4 id="返回指定键"><a href="#返回指定键" class="headerlink" title="返回指定键"></a>返回指定键</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db<span class="selector-class">.user</span><span class="selector-class">.find</span>(&#123;&#125;, &#123;<span class="string">"name"</span> : <span class="number">1</span>, <span class="string">"_id"</span> : <span class="number">0</span>&#125;)</div></pre></td></tr></table></figure>
<p>第二个大括号，我们可以对find结果显示的值进行限定，设为1表示显示，0表示不显示，<code>_id</code>默认显示。如果要将<code>id</code>屏蔽，需显示设置 <code>_id</code>为0。</p>
<h4 id="多条件"><a href="#多条件" class="headerlink" title="多条件"></a>多条件</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db</span><span class="selector-class">.users</span><span class="selector-class">.find</span>(</div><div class="line">  &#123;</div><div class="line">    <span class="attribute">status</span>: <span class="string">"A"</span>,</div><div class="line">    $or: [ &#123; age: &#123; $lt: <span class="number">30</span> &#125; &#125;, &#123; <span class="attribute">type</span>: <span class="number">1</span> &#125; ]</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p><code>$or</code>表示条件数组中的条件只要有一个符合就进行显示。<code>$or</code>其后的条件数组中，其字段的设置。</p>
<h4 id="查询一个条件的多个值"><a href="#查询一个条件的多个值" class="headerlink" title="查询一个条件的多个值"></a>查询一个条件的多个值</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="builtin-name">find</span>(&#123;<span class="string">"num"</span> : &#123;<span class="string">"<span class="variable">$in</span>"</span> : [12, 13, 23]&#125;&#125;)</div></pre></td></tr></table></figure>
<p>如果要对同一条件的多个值进行过滤，可以使用<code>$in</code>。与之相对的是<code>$nin</code>。</p>
<h4 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="builtin-name">find</span>(&#123;<span class="string">"num"</span> : &#123;<span class="string">"<span class="variable">$not</span>"</span> : [12, 13]&#125;)</div></pre></td></tr></table></figure>
<p>当要选取的元素比较多时我们可以使用<code>$not</code>，它会使不在数组中的值的文档被选中。</p>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p><strong>db.collection.update()</strong>: 第一个参数为过滤条件，第二个为upsert选项，第三个为是否更新多个文档。</p>
<h4 id="简单实例"><a href="#简单实例" class="headerlink" title="简单实例"></a>简单实例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.people.update(&#123;"_id": 1&#125;,&#123;"$set" : &#123;"name": "yang"&#125;)</div></pre></td></tr></table></figure>
<p>上面的例子中，第一个大括号为filter，第二个为进行的改动。</p>
<p>下面插入一条数据，然后对它进行改动：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db</span><span class="selector-class">.users</span><span class="selector-class">.insert</span>(</div><div class="line"> &#123;</div><div class="line">    <span class="attribute">_id</span>: <span class="number">1</span>,</div><div class="line">    <span class="attribute">name</span>: <span class="string">"sue"</span>,</div><div class="line">    <span class="attribute">age</span>: <span class="number">19</span>,</div><div class="line">    <span class="attribute">type</span>: <span class="number">1</span>,</div><div class="line">    <span class="attribute">status</span>: <span class="string">"P"</span>,</div><div class="line">    <span class="attribute">favorites</span>: &#123; <span class="attribute">artist</span>: <span class="string">"Picasso"</span>, <span class="attribute">food</span>: <span class="string">"pizza"</span> &#125;,</div><div class="line">    <span class="attribute">finished</span>: [ <span class="number">17</span>, <span class="number">3</span> ],</div><div class="line">    <span class="attribute">badges</span>: [ <span class="string">"blue"</span>, <span class="string">"black"</span> ],</div><div class="line">    <span class="attribute">points</span>: [</div><div class="line">        &#123; <span class="attribute">points</span>: <span class="number">85</span>, <span class="attribute">bonus</span>: <span class="number">20</span> &#125;,</div><div class="line">        &#123; <span class="attribute">points</span>: <span class="number">85</span>, <span class="attribute">bonus</span>: <span class="number">10</span> &#125;</div><div class="line">     ]</div><div class="line"> &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<h4 id="修改内嵌文档"><a href="#修改内嵌文档" class="headerlink" title="修改内嵌文档"></a>修改内嵌文档</h4><p>使用<code>$set</code>修改器进行，可直接通过<code>.</code>进行元素的访问</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">db.users.<span class="keyword">update</span>(</div><div class="line">   &#123; <span class="string">"favorites.artist"</span>: <span class="string">"Pisanello"</span> &#125;,</div><div class="line">   &#123;</div><div class="line">     $set: &#123; <span class="string">"favorites.food"</span>: <span class="string">"pizza"</span>&#125;</div><div class="line">   &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p> 错误的情况：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">db.users.<span class="keyword">update</span>(</div><div class="line">   &#123; <span class="string">"favorites.artist"</span>: <span class="string">"Pisanello"</span> &#125;,</div><div class="line">   &#123;</div><div class="line">     &#123; <span class="string">"favorites.food"</span>: <span class="string">"pizza"</span>&#125;</div><div class="line">   &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p>不使用<code>$set</code>修改器，其意义为进行文档替换，结果就是原来的其他元素都没了，只剩下<code>{ &quot;favorites.food&quot;: &quot;pizza&quot;}</code>.</p>
<p> <code>$set</code>不仅可以对字段的值进行更改，同时也可以对类型进行修改。</p>
<p><code>$unset</code>可以将某个不需要的值尽行删除。</p>
<h4 id="数字增加或减少"><a href="#数字增加或减少" class="headerlink" title="数字增加或减少"></a>数字增加或减少</h4><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="keyword">update</span>(&#123;<span class="string">"_id"</span> : <span class="number">1</span>&#125;, &#123;<span class="string">"$inc"</span> : &#123;<span class="string">"article"</span> : <span class="number">1</span>&#125;&#125;)</div></pre></td></tr></table></figure>
<p><code>$inc</code>表示对该字段加上某一个值，该值由文档中的字段的值决定，值为负数时可进行减法。记住，该字段必须为数字。</p>
<h4 id="数组操作"><a href="#数组操作" class="headerlink" title="数组操作"></a>数组操作</h4><h5 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db<span class="selector-class">.comment</span><span class="selector-class">.update</span>(&#123;<span class="string">"_id"</span> : <span class="number">1</span>&#125;, &#123;<span class="string">"$push"</span> : &#123;<span class="string">"comments"</span> : <span class="string">"first"</span>&#125;)</div></pre></td></tr></table></figure>
<p><code>$push</code>表示在数组已有元素的末尾插入一个值。</p>
<h5 id="添加多个"><a href="#添加多个" class="headerlink" title="添加多个"></a>添加多个</h5><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.blog.post.<span class="keyword">update</span>(&#123;<span class="string">"title"</span> : <span class="string">"Post"</span>&#125;, &#123;<span class="string">"$push"</span> : &#123;<span class="string">"tag"</span> : &#123;<span class="string">"$each"</span> : [<span class="string">"go"</span>, <span class="string">"linux"</span>, <span class="string">"database"</span>]&#125;&#125;&#125;)</div></pre></td></tr></table></figure>
<p><code>$push</code>和<code>$each</code>结合使用可以将一个数组中的多个值添加到指定字段.</p>
<h5 id="避免重复"><a href="#避免重复" class="headerlink" title="避免重复"></a>避免重复</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db<span class="selector-class">.user</span><span class="selector-class">.update</span>(&#123;<span class="string">"_id"</span> : <span class="number">1</span>&#125;, &#123;<span class="string">"$addToSet"</span> : &#123;<span class="string">"emails"</span> : <span class="string">"23132132132@qq.com"</span>&#125;)</div></pre></td></tr></table></figure>
<p><code>$addToSet</code> 可以避免重复插入，当数组中已经有要添加的值时，该语句相当于不执行。</p>
<h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><p>对于数组的删除，有两种不同方法。</p>
<h6 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db<span class="selector-class">.comment</span><span class="selector-class">.update</span>(&#123;<span class="string">"_id"</span> : <span class="number">1</span>&#125;, &#123;<span class="string">"$pop"</span> : &#123;<span class="string">"comments"</span> : <span class="number">1</span>&#125;)</div></pre></td></tr></table></figure>
<p><code>$pop</code>表示从数组末尾删除几个元素，若为负数，表示从头删除。</p>
<h6 id="pull"><a href="#pull" class="headerlink" title="pull"></a>pull</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db<span class="selector-class">.comment</span><span class="selector-class">.update</span>(&#123;&#125;, &#123;<span class="string">"$pull"</span> : &#123;<span class="string">"comments"</span> : <span class="string">"xxxx"</span>&#125;)</div></pre></td></tr></table></figure>
<p>与<code>$pop</code>根据元素位置删除元素不同，<code>$pull</code>依据条件删除元素。</p>
<h5 id="位置"><a href="#位置" class="headerlink" title="位置"></a>位置</h5><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="keyword">update</span>(&#123;<span class="string">"article"</span> : <span class="string">"post"</span>&#125;, &#123;<span class="string">"$inc"</span> : &#123;<span class="string">"comments.0.votes"</span> : <span class="number">1</span>&#125;&#125;)</div></pre></td></tr></table></figure>
<p>对于数组元素，我们也可以根据下标进行访问。</p>
<h5 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h5><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="keyword">update</span>(&#123;<span class="string">"article"</span> : <span class="string">"post"</span>&#125;, &#123;<span class="string">"$set"</span> : &#123;<span class="string">"comments.$.author"</span> : <span class="string">"Jim"</span>&#125;&#125;)</div></pre></td></tr></table></figure>
<p>有些时候，我们不知道元素在数组中的下标，但经过前面filter的过滤，可以确定该元素，可以使用<code>$</code> 占位符，它就替代了前面filter所得到的元素。</p>
<h4 id="upsert"><a href="#upsert" class="headerlink" title="upsert"></a>upsert</h4><p>如果 <code>db.collection.update()</code>，<code>db.collection.updateOne()</code>， <code>db.collection.updateMany()</code> 或者 <code>db.collection.replaceOne()</code>包含 <code>upsert : true</code>  <strong>并且</strong>没有文档匹配指定的过滤器，那么此操作会创建一个新文档并插入它。如果有匹配的文档，那么此操作修改或替换匹配的单个或多个文档。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.user.<span class="keyword">update</span>(&#123;<span class="string">"rep"</span> : <span class="number">25</span>&#125;, &#123;<span class="string">"$inc"</span> : &#123;<span class="string">"rep"</span> : <span class="number">3</span>&#125;&#125;, <span class="literal">true</span>)</div></pre></td></tr></table></figure>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db</span><span class="selector-class">.user</span><span class="selector-class">.remove</span>(&#123;&#125;)</div></pre></td></tr></table></figure>
<p>简单示例如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db</span><span class="selector-class">.users</span><span class="selector-class">.remove</span>( &#123; <span class="attribute">status </span>: false &#125;, 1)</div></pre></td></tr></table></figure>
<p>当然还有delete方法也可以删除文档：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db</span><span class="selector-class">.collection</span><span class="selector-class">.deleteOne</span>(&#123; <span class="attribute">status</span>: <span class="string">"D"</span> &#125;)</div></pre></td></tr></table></figure>

      
    </div>
    
    <footer>
        <div class="alignright">
          
          <a href='javascript:void(0)' class="share-link bdsharebuttonbox" data-cmd="more">分享</a>
        </div>
        
  
  <div class="categories">
    <a href="/categories/MongoDB/">MongoDB</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/MongoDB/">MongoDB</a>
  </div>

        <!-- partial('post/share') -->
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yangchenglong11.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Docker/">Docker</a><small>1</small></li>
  
    <li><a href="/categories/Golang/">Golang</a><small>10</small></li>
  
    <li><a href="/categories/Linux/">Linux</a><small>1</small></li>
  
    <li><a href="/categories/MongoDB/">MongoDB</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2017/01/13/正则表达式/">正则表达式</a>
      </li>
    
      <li>
        <a href="/2017/01/05/MongoDB基础/">MongoDB基础</a>
      </li>
    
      <li>
        <a href="/2016/12/27/Docker是什么/">Docker是什么</a>
      </li>
    
      <li>
        <a href="/2016/12/11/Golang-实现大数乘法/">Golang 实现大数的乘法</a>
      </li>
    
      <li>
        <a href="/2016/12/05/go并发编程基础/">go并发编程基础</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Docker/">Docker</a><small>1</small></li>
  
    <li><a href="/tags/Golang/">Golang</a><small>10</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>1</small></li>
  
    <li><a href="/tags/MongoDB/">MongoDB</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Golang/" style="font-size: 20px;">Golang</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <p>
  
  &copy; 2017 Yang Chenglong
  
  All rights reserved.</p>
  <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</div>
<div class="clearfix"></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id='bg'></div>
</body>
</html>